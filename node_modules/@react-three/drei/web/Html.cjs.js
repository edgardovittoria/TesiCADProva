"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/extends"),t=require("react"),r=require("three"),n=require("@react-three/fiber");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function s(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var a=o(e),i=s(t);const c=new r.Vector3,l=new r.Vector3,u=new r.Vector3,d=()=>{throw new Error("Html component requires a 'react-dom' package, please install it")};let f={unmountComponentAtNode:d,render:d};try{f=require("react-dom")}catch{}function m(e,t,r){const n=c.setFromMatrixPosition(e.matrixWorld);n.project(t);const o=r.width/2,s=r.height/2;return[n.x*o+o,-n.y*s+s]}const p=e=>Math.abs(e)<1e-10?0:e;function h(e,t,r=""){let n="matrix3d(";for(let r=0;16!==r;r++)n+=p(t[r]*e.elements[r])+(15!==r?",":")");return r+n}const x=(y=[1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1],e=>h(e,y));var y;const v=(e,t)=>{return h(e,[1/(r=t),1/r,1/r,1,-1/r,-1/r,-1/r,-1,1/r,1/r,1/r,1,1,1,1,1],"translate(-50%,-50%)");var r},b=i.forwardRef((({children:e,eps:t=.001,style:o,className:s,prepend:d,center:h,fullscreen:y,portal:b,distanceFactor:g,sprite:M=!1,transform:w=!1,occlude:P,onOcclude:W,zIndexRange:$=[16777271,0],calculatePosition:E=m,as:O="div",pointerEvents:j="auto",...F},T)=>{var C;const R=n.useThree((({gl:e})=>e)),z=n.useThree((({camera:e})=>e)),q=n.useThree((({scene:e})=>e)),I=n.useThree((({size:e})=>e)),N=n.useThree((({raycaster:e})=>e)),[A]=i.useState((()=>document.createElement(O))),_=i.useRef(null),k=i.useRef(0),V=i.useRef([0,0]),D=i.useRef(null),H=i.useRef(null),S=null!==(C=null==b?void 0:b.current)&&void 0!==C?C:R.domElement.parentNode;i.useEffect((()=>{if(_.current){if(q.updateMatrixWorld(),w)A.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{const e=E(_.current,z,I);A.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${e[0]}px,${e[1]}px,0);transform-origin:0 0;`}return S&&(d?S.prepend(A):S.appendChild(A)),()=>{S&&S.removeChild(A),f.unmountComponentAtNode(A)}}}),[S,w]);const L=i.useMemo((()=>w?{position:"absolute",top:0,left:0,width:I.width,height:I.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:h?"translate3d(-50%,-50%,0)":"none",...y&&{top:-I.height/2,left:-I.width/2,width:I.width,height:I.height},...o}),[o,h,y,I,w]),Z=i.useMemo((()=>({position:"absolute",pointerEvents:j})),[j]);i.useLayoutEffect((()=>{w?f.render(i.createElement("div",{ref:D,style:L},i.createElement("div",{ref:H,style:Z},i.createElement("div",{ref:T,className:s,style:o,children:e}))),A):f.render(i.createElement("div",{ref:T,style:L,className:s,children:e}),A)}));const B=i.useRef(!0);return n.useFrame((()=>{if(_.current){z.updateMatrixWorld(),_.current.updateWorldMatrix(!0,!1);const e=w?V.current:E(_.current,z,I);if(w||Math.abs(k.current-z.zoom)>t||Math.abs(V.current[0]-e[0])>t||Math.abs(V.current[1]-e[1])>t){const t=function(e,t){const r=c.setFromMatrixPosition(e.matrixWorld),n=l.setFromMatrixPosition(t.matrixWorld),o=r.sub(n),s=t.getWorldDirection(u);return o.angleTo(s)>Math.PI/2}(_.current,z);let n=!1;"boolean"==typeof P?!0===P&&(n=[q]):Array.isArray(P)&&(n=P.map((e=>e.current)));const o=B.current;if(n){const e=function(e,t,r,n){const o=c.setFromMatrixPosition(e.matrixWorld),s=o.clone();s.project(t),r.setFromCamera(s,t);const a=r.intersectObjects(n,!0);if(a.length){const e=a[0].distance;return o.distanceTo(r.ray.origin)<e}return!0}(_.current,z,N,n);B.current=e&&!t}else B.current=!t;if(o!==B.current&&(W?W(!B.current):A.style.display=B.current?"block":"none"),A.style.zIndex=`${function(e,t,n){if(t instanceof r.PerspectiveCamera||t instanceof r.OrthographicCamera){const r=c.setFromMatrixPosition(e.matrixWorld),o=l.setFromMatrixPosition(t.matrixWorld),s=r.distanceTo(o),a=(n[1]-n[0])/(t.far-t.near),i=n[1]-a*t.far;return Math.round(a*s+i)}}(_.current,z,$)}`,w){const[e,t]=[I.width/2,I.height/2],r=z.projectionMatrix.elements[5]*t,{isOrthographicCamera:n,top:o,left:s,bottom:a,right:i}=z,c=x(z.matrixWorldInverse),l=n?`scale(${r})translate(${p(-(i+s)/2)}px,${p((o+a)/2)}px)`:`translateZ(${r}px)`;let u=_.current.matrixWorld;M&&(u=z.matrixWorldInverse.clone().transpose().copyPosition(u).scale(_.current.scale),u.elements[3]=u.elements[7]=u.elements[11]=0,u.elements[15]=1),A.style.width=I.width+"px",A.style.height=I.height+"px",A.style.perspective=n?"":`${r}px`,D.current&&H.current&&(D.current.style.transform=`${l}${c}translate(${e}px,${t}px)`,H.current.style.transform=v(u,1/((g||10)/400)))}else{const t=void 0===g?1:function(e,t){if(t instanceof r.OrthographicCamera)return t.zoom;if(t instanceof r.PerspectiveCamera){const r=c.setFromMatrixPosition(e.matrixWorld),n=l.setFromMatrixPosition(t.matrixWorld),o=t.fov*Math.PI/180,s=r.distanceTo(n);return 1/(2*Math.tan(o/2)*s)}return 1}(_.current,z)*g;A.style.transform=`translate3d(${e[0]}px,${e[1]}px,0) scale(${t})`}V.current=e,k.current=z.zoom}}})),i.createElement("group",a.default({},F,{ref:_}))}));exports.Html=b;
